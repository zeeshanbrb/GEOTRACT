<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sites Management - GeoTrack</title>
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <link rel="stylesheet" href="../static/css/modern-design.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <span>üìç</span>
            <span>GeoTrack</span>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="sidebar-nav-item admin-only">
                    <a href="dashboard.html" class="sidebar-nav-link">
                        <span>üìä</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="overview.html" class="sidebar-nav-link">
                        <span>üìà</span>
                        <span>Analytics</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="logs.html" class="sidebar-nav-link">
                        <span>üìù</span>
                        <span>Event Logs</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="flows.html" class="sidebar-nav-link">
                        <span>üîÑ</span>
                        <span>User Flows</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="returning-visitors.html" class="sidebar-nav-link">
                        <span>üë•</span>
                        <span>Returning Visitors</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="sites.html" class="sidebar-nav-link active">
                        <span>üåê</span>
                        <span>Sites</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="users.html" class="sidebar-nav-link">
                        <span>üë§</span>
                        <span>Users</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="audit-logs.html" class="sidebar-nav-link">
                        <span>üîç</span>
                        <span>Audit Logs</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="integration.html" class="sidebar-nav-link">
                        <span>üîó</span>
                        <span>Integration</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="profile.html" class="sidebar-nav-link">
                        <span>‚öôÔ∏è</span>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div style="margin-top: auto; padding-top: var(--space-8); border-top: 1px solid rgba(255, 255, 255, 0.05);">
            <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4);">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;" id="user-avatar">
                    A
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 0.875rem; font-weight: 600;" id="user-email">Loading...</div>
                    <div style="font-size: 0.75rem; color: var(--color-text-tertiary);" id="user-role">...</div>
                </div>
            </div>
            <button onclick="API.logout()" class="btn btn-ghost w-full" style="font-size: 0.875rem;">
                <span>üö™</span>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header style="margin-bottom: var(--space-8);">
            <div class="flex items-center justify-between">
                <div>
                    <h1 style="margin-bottom: var(--space-2);">üåê Sites Management</h1>
                    <p style="color: var(--color-text-secondary); margin: 0;">Manage tracked websites and generate tracking codes</p>
                </div>
                <button class="btn btn-primary" onclick="showCreateSiteModal()">
                    <span>‚ûï</span>
                    <span>Add Site</span>
                </button>
            </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-3 mb-6">
            <div class="stat-card">
                <div class="stat-label">Total Sites</div>
                <div class="stat-value" id="stat-total">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Sites</div>
                <div class="stat-value" id="stat-active">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Events</div>
                <div class="stat-value" id="stat-events">-</div>
            </div>
        </div>

        <!-- Sites Table -->
        <div class="card">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Site</th>
                            <th>Domain</th>
                            <th>Site Key</th>
                            <th>Status</th>
                            <th>Events</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sites-table-body">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: var(--space-8); color: var(--color-text-tertiary);">
                                Loading sites...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Create Site Modal -->
    <div id="create-site-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: var(--z-modal); align-items: center; justify-content: center;">
        <div class="card" style="max-width: 500px; width: 90%;">
            <h3 style="margin-bottom: var(--space-6);">‚ûï Add New Site</h3>
            <form id="create-site-form">
                <div class="form-group">
                    <label class="form-label">Site Name</label>
                    <input type="text" id="new-site-name" class="form-input" placeholder="My Website" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Domain</label>
                    <input type="text" id="new-site-domain" class="form-input" placeholder="example.com" required>
                </div>
                <div class="flex gap-3" style="justify-content: flex-end; margin-top: var(--space-6);">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateSiteModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="create-btn">Create Site</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: var(--z-modal); align-items: center; justify-content: center;">
        <div class="card" style="max-width: 450px; width: 90%;">
            <h3 style="margin-bottom: var(--space-4); color: #ef4444;">üóëÔ∏è Delete Site</h3>
            <p style="color: var(--color-text-secondary); margin-bottom: var(--space-2);">
                Are you sure you want to delete:
            </p>
            <p style="font-weight: 700; font-size: 1.1rem; margin-bottom: var(--space-2);" id="delete-site-name">-</p>
            <p style="color: #ef4444; font-size: 0.875rem; margin-bottom: var(--space-6);">
                ‚ö†Ô∏è This will permanently delete all events, visitors, and analytics data for this site.
            </p>
            <div class="flex gap-3" style="justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="hideDeleteModal()">Cancel</button>
                <button class="btn btn-danger" id="confirm-delete-btn" onclick="confirmDelete()">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>
    </div>

    <script src="../static/js/api-client.js"></script>
    <script>
        let siteToDelete = null;

        async function initPage() {
            if (!API.requireAuth()) return;
            if (!API.isAdmin()) {
                API.showToast('Admin access required', 'error');
                window.location.href = 'overview.html';
                return;
            }
            await loadUserProfile();
            await loadSites();
        }

        async function loadUserProfile() {
            try {
                const user = await API.getCurrentUser();
                document.getElementById('user-email').textContent = user.email || 'User';
                document.getElementById('user-role').textContent = (user.role || 'user').toUpperCase();
                document.getElementById('user-avatar').textContent = (user.email || 'U')[0].toUpperCase();
            } catch (error) {
                console.error('Profile load error:', error);
            }
        }

        async function loadSites() {
            try {
                const data = await API.getSites();
                
                // Update stats
                document.getElementById('stat-total').textContent = data.length;
                document.getElementById('stat-active').textContent = 
                    data.filter(s => s.status === 'connected').length;
                document.getElementById('stat-events').textContent = 
                    API.formatNumber(data.reduce((sum, s) => sum + (s.total_events || 0), 0));

                const tbody = document.getElementById('sites-table-body');

                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: var(--space-8); color: var(--color-text-tertiary);">
                                No sites found. Click "Add Site" to get started.
                            </td>
                        </tr>`;
                    return;
                }

                tbody.innerHTML = data.map(site => {
                    const statusColors = {
                        pending:      'warning',
                        connected:    'success',
                        disconnected: 'error'
                    };

                    // ‚úÖ FIX: Use public_key instead of site_key
                    const siteKey = site.public_key || site.site_key || 'N/A';
                    const shortKey = siteKey.length > 25 
                        ? siteKey.substring(0, 25) + '...' 
                        : siteKey;

                    return `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${site.name || 'Unnamed'}</div>
                            </td>
                            <td>
                                <code style="font-size: 0.875rem;">${site.domain}</code>
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: var(--space-2);">
                                    <code style="font-size: 0.75rem;" title="${siteKey}">${shortKey}</code>
                                    <button 
                                        class="btn btn-sm btn-ghost" 
                                        onclick="copyKey('${siteKey}')" 
                                        title="Copy site key">
                                        üìã
                                    </button>
                                </div>
                            </td>
                            <td>
                                <span class="badge badge-${statusColors[site.status] || 'secondary'}">
                                    ${site.status || 'unknown'}
                                </span>
                            </td>
                            <td><strong>${API.formatNumber(site.total_events || 0)}</strong></td>
                            <td style="font-size: 0.875rem;">${API.formatDate(site.created_at)}</td>
                            <td>
                                <div style="display: flex; gap: var(--space-2);">
                                    <button 
                                        class="btn btn-sm btn-secondary" 
                                        onclick="viewIntegration(${site.id})" 
                                        title="View integration code">
                                        üîå
                                    </button>
                                    <button 
                                        class="btn btn-sm btn-danger" 
                                        onclick="showDeleteModal(${site.id}, '${(site.domain || '').replace(/'/g, "\\'")}')">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Load sites error:', error);
                API.showToast('Failed to load sites', 'error');
            }
        }

        // ‚úÖ Copy site key to clipboard
        function copyKey(key) {
            navigator.clipboard.writeText(key)
                .then(() => API.showToast('Site key copied!', 'success'))
                .catch(() => {
                    // Fallback
                    const el = document.createElement('textarea');
                    el.value = key;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    API.showToast('Site key copied!', 'success');
                });
        }

        // ‚úÖ Create Site Modal
        function showCreateSiteModal() {
            document.getElementById('create-site-modal').style.display = 'flex';
            document.getElementById('new-site-name').focus();
        }

        function hideCreateSiteModal() {
            document.getElementById('create-site-modal').style.display = 'none';
            document.getElementById('create-site-form').reset();
        }

        document.getElementById('create-site-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('create-btn');
            btn.disabled = true;
            btn.textContent = 'Creating...';

            try {
                const siteData = {
                    name:      document.getElementById('new-site-name').value.trim(),
                    domain:    document.getElementById('new-site-domain').value.trim(),
                    client_id: 1
                };

                await API.createSite(siteData);
                API.showToast('Site created successfully!', 'success');
                hideCreateSiteModal();
                await loadSites();

            } catch (error) {
                console.error('Create site error:', error);
                API.showToast(error.message || 'Failed to create site', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Site';
            }
        });

        // ‚úÖ FIXED Delete Flow
        function showDeleteModal(siteId, siteDomain) {
            siteToDelete = siteId;
            document.getElementById('delete-site-name').textContent = siteDomain;
            document.getElementById('delete-modal').style.display = 'flex';
        }

        function hideDeleteModal() {
            siteToDelete = null;
            document.getElementById('delete-modal').style.display = 'none';
        }

        async function confirmDelete() {
            if (!siteToDelete) {
                API.showToast('No site selected', 'error');
                return;
            }
        
            const btn = document.getElementById('confirm-delete-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Deleting...';
        
            try {
                // Direct fetch ki jagah API client use karein taake auth automatically handle ho
                await API.deleteSite(siteToDelete); 
                
                API.showToast('‚úÖ Site deleted successfully!', 'success');
                hideDeleteModal();
                await loadSites();
        
            } catch (error) {
                console.error('‚ùå Delete failed:', error);
                API.showToast(error.message || 'Failed to delete site', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üóëÔ∏è Delete';
            }
        }
        function viewIntegration(siteId) {
            window.location.href = `integration.html?site=${siteId}`;
        }

        // Close modals on background click
        document.getElementById('create-site-modal').addEventListener('click', function(e) {
            if (e.target === this) hideCreateSiteModal();
        });

        document.getElementById('delete-modal').addEventListener('click', function(e) {
            if (e.target === this) hideDeleteModal();
        });

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>