<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sites Management - GeoTrack</title>
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <link rel="stylesheet" href="../static/css/modern-design.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <span>ğŸ“</span>
            <span>GeoTrack</span>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="sidebar-nav-item admin-only">
                    <a href="dashboard.html" class="sidebar-nav-link">
                        <span>ğŸ“Š</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="overview.html" class="sidebar-nav-link">
                        <span>ğŸ“ˆ</span>
                        <span>Analytics</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="logs.html" class="sidebar-nav-link">
                        <span>ğŸ“</span>
                        <span>Event Logs</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="flows.html" class="sidebar-nav-link">
                        <span>ğŸ”„</span>
                        <span>User Flows</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="returning-visitors.html" class="sidebar-nav-link">
                        <span>ğŸ‘¥</span>
                        <span>Returning Visitors</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="sites.html" class="sidebar-nav-link active">
                        <span>ğŸŒ</span>
                        <span>Sites</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="users.html" class="sidebar-nav-link">
                        <span>ğŸ‘¤</span>
                        <span>Users</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="audit-logs.html" class="sidebar-nav-link">
                        <span>ğŸ”</span>
                        <span>Audit Logs</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="integration.html" class="sidebar-nav-link">
                        <span>ğŸ”—</span>
                        <span>Integration</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="profile.html" class="sidebar-nav-link">
                        <span>âš™ï¸</span>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div style="margin-top: auto; padding-top: var(--space-8); border-top: 1px solid rgba(255, 255, 255, 0.05);">
            <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4);">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                    A
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 0.875rem; font-weight: 600;" id="user-email">Loading...</div>
                    <div style="font-size: 0.75rem; color: var(--color-text-tertiary);" id="user-role">...</div>
                </div>
            </div>
            <button onclick="API.logout()" class="btn btn-ghost w-full" style="font-size: 0.875rem;">
                <span>ğŸšª</span>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header style="margin-bottom: var(--space-8);">
            <div class="flex items-center justify-between">
                <div>
                    <h1 style="margin-bottom: var(--space-2);">Sites Management</h1>
                    <p style="color: var(--color-text-secondary); margin: 0;">Manage tracked websites and generate tracking codes</p>
                </div>
                <button class="btn btn-primary" onclick="showCreateSiteModal()">
                    <span>â•</span>
                    <span>Add Site</span>
                </button>
            </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-3 mb-6">
            <div class="stat-card">
                <div class="stat-label">Total Sites</div>
                <div class="stat-value" id="stat-total">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Sites</div>
                <div class="stat-value" id="stat-active">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Events</div>
                <div class="stat-value" id="stat-events">-</div>
            </div>
        </div>

        <!-- Sites Table -->
        <div class="card">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Site</th>
                            <th>Domain</th>
                            <th>Site Key</th>
                            <th>Status</th>
                            <th>Events</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sites-table-body">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: var(--space-8); color: var(--color-text-tertiary);">
                                Loading sites...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Create Site Modal -->
    <div id="create-site-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: var(--z-modal); align-items: center; justify-content: center;">
        <div class="card" style="max-width: 500px; width: 90%;">
            <h3 style="margin-bottom: var(--space-6);">Add New Site</h3>
            
            <form id="create-site-form">
                <div class="form-group">
                    <label class="form-label">Site Name</label>
                    <input type="text" id="new-site-name" class="form-input" placeholder="My Website" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Domain</label>
                    <input type="text" id="new-site-domain" class="form-input" placeholder="example.com" required>
                </div>
                
                <div class="flex gap-3" style="justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateSiteModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Site</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../static/js/api-client.js"></script>
    <script>
        async function initPage() {
            if (!API.requireAuth()) return;
            if (!API.isAdmin()) {
                API.showToast('Admin access required', 'error');
                window.location.href = 'overview.html';
                return;
            }
            await loadSites();
        }

        async function loadSites() {
            try {
                const data = await API.getSites();
                
                // Update stats
                document.getElementById('stat-total').textContent = data.length;
                document.getElementById('stat-active').textContent = data.filter(s => s.status === 'connected').length;
                document.getElementById('stat-events').textContent = API.formatNumber(
                    data.reduce((sum, s) => sum + (s.total_events || 0), 0)
                );

                // Update table
                const tbody = document.getElementById('sites-table-body');
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: var(--space-8); color: var(--color-text-tertiary);">No sites found. Click "Add Site" to get started.</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(site => {
                    const statusColors = {
                        pending: 'warning',
                        connected: 'success',
                        disconnected: 'error'
                    };
                    
                    return `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${site.name || 'Unnamed'}</div>
                            </td>
                            <td>
                                <code style="font-size: 0.875rem;">${site.domain}</code>
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: var(--space-2);">
                                    <code style="font-size: 0.75rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${site.site_key}</code>
                                    <button class="btn btn-sm btn-ghost" onclick="API.copyToClipboard('${site.site_key}')" title="Copy site key">
                                        ğŸ“‹
                                    </button>
                                </div>
                            </td>
                            <td>
                                <span class="badge badge-${statusColors[site.status] || 'secondary'}">
                                    ${site.status}
                                </span>
                            </td>
                            <td><strong>${API.formatNumber(site.total_events || 0)}</strong></td>
                            <td style="font-size: 0.875rem;">${API.formatDate(site.created_at)}</td>
                            <td>
                                <div style="display: flex; gap: var(--space-2);">
                                    <button class="btn btn-sm btn-secondary" onclick="viewIntegration(${site.id})" title="View integration">
                                        ğŸ”Œ
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteSite(${site.id}, '${site.domain}')">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Load sites error:', error);
                API.showToast('Failed to load sites', 'error');
            }
        }

        function showCreateSiteModal() {
            document.getElementById('create-site-modal').style.display = 'flex';
        }

        function hideCreateSiteModal() {
            document.getElementById('create-site-modal').style.display = 'none';
            document.getElementById('create-site-form').reset();
        }

        document.getElementById('create-site-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const siteData = {
                    name: document.getElementById('new-site-name').value,
                    domain: document.getElementById('new-site-domain').value,
                    client_id: 1  // Default client
                };

                await API.createSite(siteData);
                hideCreateSiteModal();
                await loadSites();
            } catch (error) {
                console.error('Create site error:', error);
                API.showToast(error.message || 'Failed to create site', 'error');
            }
        });

        async function deleteSite(id, domain) {
            API.confirm(`Are you sure you want to delete site: ${domain}? This will delete all associated events.`, async () => {
                try {
                    await API.deleteSite(id);
                    await loadSites();
                } catch (error) {
                    API.showToast('Failed to delete site', 'error');
                }
            });
        }

        function viewIntegration(siteId) {
            window.location.href = `integration.html?site=${siteId}`;
        }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
