<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Logs - GeoTrack</title>
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <link rel="stylesheet" href="../static/css/modern-design.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <span>üìç</span>
            <span>GeoTrack</span>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="sidebar-nav-item admin-only">
                    <a href="dashboard.html" class="sidebar-nav-link">
                        <span>üìä</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="overview.html" class="sidebar-nav-link">
                        <span>üìà</span>
                        <span>Analytics</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="logs.html" class="sidebar-nav-link">
                        <span>üìù</span>
                        <span>Event Logs</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="flows.html" class="sidebar-nav-link">
                        <span>üîÑ</span>
                        <span>User Flows</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="returning-visitors.html" class="sidebar-nav-link">
                        <span>üë•</span>
                        <span>Returning Visitors</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="sites.html" class="sidebar-nav-link">
                        <span>üåê</span>
                        <span>Sites</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="users.html" class="sidebar-nav-link">
                        <span>üë§</span>
                        <span>Users</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="audit-logs.html" class="sidebar-nav-link active">
                        <span>üîç</span>
                        <span>Audit Logs</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="integration.html" class="sidebar-nav-link">
                        <span>üîó</span>
                        <span>Integration</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="profile.html" class="sidebar-nav-link">
                        <span>‚öôÔ∏è</span>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div style="margin-top: auto; padding-top: var(--space-8); border-top: 1px solid rgba(255, 255, 255, 0.05);">
            <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4);">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                    A
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 0.875rem; font-weight: 600;" id="user-email">Loading...</div>
                    <div style="font-size: 0.75rem; color: var(--color-text-tertiary);" id="user-role">...</div>
                </div>
            </div>
            <button onclick="API.logout()" class="btn btn-ghost w-full" style="font-size: 0.875rem;">
                <span>üö™</span>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header style="margin-bottom: var(--space-8);">
            <h1 style="margin-bottom: var(--space-2);">Audit Logs</h1>
            <p style="color: var(--color-text-secondary); margin: 0;">Track all system activities and changes</p>
        </header>

        <!-- Filters -->
        <div class="card mb-6" style="padding: var(--space-4);">
            <div class="grid grid-4 gap-3">
                <div>
                    <label class="form-label" style="margin-bottom: var(--space-2);">Action Type</label>
                    <select class="form-select" id="filter-action" onchange="loadLogs()">
                        <option value="">All Actions</option>
                        <option value="create">Create</option>
                        <option value="update">Update</option>
                        <option value="delete">Delete</option>
                        <option value="login">Login</option>
                    </select>
                </div>
                <div>
                    <label class="form-label" style="margin-bottom: var(--space-2);">Target Type</label>
                    <select class="form-select" id="filter-target" onchange="loadLogs()">
                        <option value="">All Targets</option>
                        <option value="client">Client</option>
                        <option value="site">Site</option>
                        <option value="user">User</option>
                        <option value="token">Token</option>
                    </select>
                </div>
                <div>
                    <label class="form-label" style="margin-bottom: var(--space-2);">Date From</label>
                    <input type="date" class="form-input" id="date-from" onchange="loadLogs()">
                </div>
                <div>
                    <label class="form-label" style="margin-bottom: var(--space-2);">Date To</label>
                    <input type="date" class="form-input" id="date-to" onchange="loadLogs()">
                </div>
            </div>
        </div>

        <!-- Audit Logs Table -->
        <div class="card">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Target</th>
                            <th>IP Address</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="audit-table">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: var(--space-8); color: var(--color-text-tertiary);">
                                Loading audit logs...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div style="padding: var(--space-4); border-top: 1px solid rgba(255, 255, 255, 0.05); display: flex; justify-content: space-between; align-items: center;">
                <div style="color: var(--color-text-secondary); font-size: 0.875rem;">
                    Page <span id="page-num">1</span>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-secondary" onclick="prevPage()" id="btn-prev">Previous</button>
                    <button class="btn btn-sm btn-secondary" onclick="nextPage()" id="btn-next">Next</button>
                </div>
            </div>
        </div>
    </main>

    <script src="../static/js/api-client.js"></script>
    <script>
        let currentPage = 1;

        async function initPage() {
            if (!API.requireAuth()) return;
            if (!API.isAdmin()) {
                API.showToast('Admin access required', 'error');
                window.location.href = 'overview.html';
                return;
            }
            await loadLogs();
        }

        async function loadLogs(page = 1) {
            try {
                currentPage = page;
                
                const params = {
                    page: currentPage,
                    limit: 50
                };
                
                const action = document.getElementById('filter-action').value;
                const target = document.getElementById('filter-target').value;
                const dateFrom = document.getElementById('date-from').value;
                const dateTo = document.getElementById('date-to').value;
                
                if (action) params.action = action;
                if (target) params.target_type = target;
                if (dateFrom) params.start_date = dateFrom;
                if (dateTo) params.end_date = dateTo;
                
                const data = await API.getAuditLogs(params);
                
                const tbody = document.getElementById('audit-table');
                if (!data.logs || data.logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--space-8); color: var(--color-text-tertiary);">No audit logs found</td></tr>';
                    return;
                }
                
                const actionColors = {
                    create: 'success',
                    update: 'primary',
                    delete: 'danger',
                    login: 'secondary'
                };
                
                tbody.innerHTML = data.logs.map(log => {
                    const actionType = log.action.split('_')[0];
                    const badgeColor = actionColors[actionType] || 'secondary';
                    
                    return `
                        <tr>
                            <td style="white-space: nowrap;">
                                <div style="font-size: 0.875rem;">${API.formatTime(log.timestamp)}</div>
                                <small style="color: var(--color-text-tertiary);">${API.formatDate(log.timestamp)}</small>
                            </td>
                            <td>
                                ${log.user_id ? `<code>User #${log.user_id}</code>` : '<span style="color: var(--color-text-tertiary);">System</span>'}
                            </td>
                            <td>
                                <span class="badge badge-${badgeColor}">${log.action}</span>
                            </td>
                            <td>
                                ${log.target_type ? `
                                    <div style="font-weight: 600;">${log.target_type.toUpperCase()}</div>
                                    ${log.target_id ? `<small style="color: var(--color-text-tertiary);">ID: ${log.target_id}</small>` : ''}
                                ` : '-'}
                            </td>
                            <td><code style="font-size: 0.875rem;">${log.ip_address || '-'}</code></td>
                            <td>
                                ${log.details_json ? `
                                    <button class="btn btn-sm btn-ghost" onclick='showDetails(${JSON.stringify(log.details_json)})'>View</button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('page-num').textContent = currentPage;
                document.getElementById('btn-prev').disabled = currentPage === 1;
                document.getElementById('btn-next').disabled = !data.logs || data.logs.length < 50;
                
            } catch (error) {
                console.error('Load logs error:', error);
                API.showToast('Failed to load audit logs', 'error');
            }
        }

        function showDetails(details) {
            const formatted = JSON.stringify(details, null, 2);
            alert('Audit Details:\n\n' + formatted);
        }

        function prevPage() {
            if (currentPage > 1) {
                loadLogs(currentPage - 1);
            }
        }

        function nextPage() {
            loadLogs(currentPage + 1);
        }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
