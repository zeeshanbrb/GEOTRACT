<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GeoTrack Analytics</title>
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <link rel="stylesheet" href="../static/css/modern-design.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <span>üìç</span>
            <span>GeoTrack</span>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="sidebar-nav-item">
                    <a href="dashboard.html" class="sidebar-nav-link active">
                        <span>üìä</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="overview.html" class="sidebar-nav-link">
                        <span>üìà</span>
                        <span>Analytics</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="logs.html" class="sidebar-nav-link">
                        <span>üìù</span>
                        <span>Event Logs</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="flows.html" class="sidebar-nav-link">
                        <span>üîÑ</span>
                        <span>User Flows</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="returning-visitors.html" class="sidebar-nav-link">
                        <span>üë•</span>
                        <span>Returning Visitors</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="sites.html" class="sidebar-nav-link">
                        <span>üåê</span>
                        <span>Sites</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="users.html" class="sidebar-nav-link">
                        <span>üë§</span>
                        <span>Users</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="audit-logs.html" class="sidebar-nav-link">
                        <span>üîç</span>
                        <span>Audit Logs</span>
                    </a>
                </li>
                <li class="sidebar-nav-item admin-only">
                    <a href="integration.html" class="sidebar-nav-link">
                        <span>üîó</span>
                        <span>Integration</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="profile.html" class="sidebar-nav-link">
                        <span>‚öôÔ∏è</span>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div style="margin-top: auto; padding-top: var(--space-8); border-top: 1px solid rgba(255, 255, 255, 0.05);">
            <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4);">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                    A
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 0.875rem; font-weight: 600;" id="user-email">Loading...</div>
                    <div style="font-size: 0.75rem; color: var(--color-text-tertiary);" id="user-role">...</div>
                </div>
            </div>
            <button onclick="API.logout()" class="btn btn-ghost w-full" style="font-size: 0.875rem;">
                <span>üö™</span>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header style="margin-bottom: var(--space-8);">
            <div class="flex items-center justify-between" style="margin-bottom: var(--space-4);">
                <div>
                    <h1 style="margin-bottom: var(--space-2);">Dashboard</h1>
                    <p style="color: var(--color-text-secondary); margin: 0;">Welcome back! Here's your analytics overview.</p>
                </div>
                <div class="flex gap-3">
                    <select id="date-range" class="form-select" style="width: auto;">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                    <button class="btn btn-primary" onclick="refreshDashboard()">
                        <span>üîÑ</span>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-4 mb-6">
            <div class="stat-card slide-up">
                <div class="stat-label">Total Events</div>
                <div class="stat-value" id="stat-events">-</div>
                <div class="stat-change positive">
                    <span>‚Üë</span>
                    <span id="stat-events-change">-</span>
                </div>
            </div>
            
            <div class="stat-card slide-up" style="animation-delay: 0.1s;">
                <div class="stat-label">Page Views</div>
                <div class="stat-value" id="stat-pageviews">-</div>
                <div class="stat-change positive">
                    <span>‚Üë</span>
                    <span id="stat-pageviews-change">-</span>
                </div>
            </div>
            
            <div class="stat-card slide-up" style="animation-delay: 0.2s;">
                <div class="stat-label">Unique Visitors</div>
                <div class="stat-value" id="stat-visitors">-</div>
                <div class="stat-change positive">
                    <span>‚Üë</span>
                    <span id="stat-visitors-change">-</span>
                </div>
            </div>
            
            <div class="stat-card slide-up" style="animation-delay: 0.3s;">
                <div class="stat-label">Avg. Time on Page</div>
                <div class="stat-value" id="stat-avg-time">-</div>
                <div class="stat-change positive">
                    <span>‚Üë</span>
                    <span id="stat-avg-time-change">-</span>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-2 mb-6">
            <!-- Visitors Trend Chart -->
            <div class="card slide-up" style="animation-delay: 0.4s;">
                <h3 style="margin-bottom: var(--space-4);">Visitors Trend</h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="visitorsChart"></canvas>
                </div>
            </div>
            
            <!-- Geographic Distribution -->
            <div class="card slide-up" style="animation-delay: 0.5s;">
                <h3 style="margin-bottom: var(--space-4);">Top Countries</h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="geoChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Activity & Top Pages -->
        <div class="grid grid-2 mb-6">
            <!-- Recent Events -->
            <div class="card slide-up" style="animation-delay: 0.6s;">
                <div class="flex items-center justify-between mb-4">
                    <h3 style="margin: 0;">Recent Events</h3>
                    <a href="logs.html" class="btn btn-sm btn-ghost">View All ‚Üí</a>
                </div>
                <div id="recent-events" style="max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; padding: var(--space-8); color: var(--color-text-tertiary);">
                        Loading...
                    </div>
                </div>
            </div>
            
            <!-- Top Pages -->
            <div class="card slide-up" style="animation-delay: 0.7s;">
                <div class="flex items-center justify-between mb-4">
                    <h3 style="margin: 0;">Top Pages</h3>
                    <a href="overview.html" class="btn btn-sm btn-ghost">View All ‚Üí</a>
                </div>
                <div id="top-pages">
                    <div style="text-align: center; padding: var(--space-8); color: var(--color-text-tertiary);">
                        Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Stats (Admin Only) -->
        <div class="admin-only">
            <div class="card slide-up" style="animation-delay: 0.8s;">
                <h3 style="margin-bottom: var(--space-4);">System Statistics</h3>
                <div class="grid grid-3">
                    <div>
                        <div class="stat-label">Total Clients</div>
                        <div class="stat-value" style="font-size: 1.5rem;" id="admin-clients">-</div>
                    </div>
                    <div>
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" style="font-size: 1.5rem;" id="admin-users">-</div>
                    </div>
                    <div>
                        <div class="stat-label">Total Events</div>
                        <div class="stat-value" style="font-size: 1.5rem;" id="admin-events">-</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../static/js/api-client.js"></script>
    <script>
        let visitorsChart, geoChart;

        // Initialize Dashboard
        async function initDashboard() {
            try {
                // Check authentication
                if (!API.requireAuth()) return;

                // Load overview data
                await loadOverview();
                
                // Load recent events
                await loadRecentEvents();
                
                // Load admin stats if admin
                if (API.isAdmin()) {
                    await loadAdminStats();
                }
                
                // Initialize charts
                initCharts();
                
            } catch (error) {
                console.error('Dashboard init error:', error);
                API.showToast('Failed to load dashboard', 'error');
            }
        }

        async function loadOverview() {
            try {
                const data = await API.getOverview();
                
                // Update stats
                document.getElementById('stat-events').textContent = API.formatNumber(data.total_events || 0);
                document.getElementById('stat-pageviews').textContent = API.formatNumber(data.pageviews || 0);
                document.getElementById('stat-visitors').textContent = API.formatNumber(data.unique_visitors || 0);
                document.getElementById('stat-avg-time').textContent = (data.avg_time_on_page || 45) + 's';
                
                // Mock change percentages
                document.getElementById('stat-events-change').textContent = '+12%';
                document.getElementById('stat-pageviews-change').textContent = '+8%';
                document.getElementById('stat-visitors-change').textContent = '+15%';
                document.getElementById('stat-avg-time-change').textContent = '+3%';
                
            } catch (error) {
                console.error('Load overview error:', error);
            }
        }

        async function loadRecentEvents() {
            try {
                const data = await API.getLive({ limit: 10 });
                const container = document.getElementById('recent-events');
                
                if (!data.events || data.events.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: var(--space-8); color: var(--color-text-tertiary);">No recent events</div>';
                    return;
                }
                
                container.innerHTML = data.events.map(event => `
                    <div style="padding: var(--space-3); border-bottom: 1px solid rgba(255, 255, 255, 0.05); display: flex; align-items: center; gap: var(--space-3);">
                        <div style="font-size: 1.5rem;">${event.country ? API.countryFlag(event.country_code) : 'üåç'}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.875rem; font-weight: 600; color: var(--color-text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${event.url || 'Unknown'}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--color-text-tertiary);">
                                ${event.city || 'Unknown'}, ${event.country || 'Unknown'} ‚Ä¢ ${API.formatRelativeTime(event.timestamp)}
                            </div>
                        </div>
                        <span class="badge badge-primary">${event.event_type}</span>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Load recent events error:', error);
            }
        }

        async function loadAdminStats() {
            try {
                const data = await API.get('/api/v1/admin/stats');
                
                document.getElementById('admin-clients').textContent = data.total_clients || 0;
                document.getElementById('admin-users').textContent = data.total_users || 0;
                document.getElementById('admin-events').textContent = API.formatNumber(data.total_events || 0);
                
            } catch (error) {
                console.error('Load admin stats error:', error);
            }
        }

        async function initCharts() {
            try {
                // Get trend data
                const trendData = await API.getTrends({ days: 30 });
                
                // Visitors Trend Chart
                const ctx1 = document.getElementById('visitorsChart').getContext('2d');
                visitorsChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: trendData.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                        datasets: [{
                            label: 'Unique Visitors',
                            data: trendData.map(d => d.unique_visitors),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Returning Visitors',
                            data: trendData.map(d => d.returning_visitors),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                labels: { color: '#cbd5e1' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            }
                        }
                    }
                });
                
                // Geographic Chart
                const geoData = await API.getGeo();
                const topCountries = geoData.slice(0, 5);
                
                const ctx2 = document.getElementById('geoChart').getContext('2d');
                geoChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: topCountries.map(d => d.country),
                        datasets: [{
                            data: topCountries.map(d => d.visitors),
                            backgroundColor: [
                                '#3b82f6',
                                '#8b5cf6',
                                '#10b981',
                                '#f59e0b',
                                '#ef4444'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#cbd5e1', padding: 15 }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Init charts error:', error);
            }
        }

        async function refreshDashboard() {
            API.showLoader();
            try {
                await loadOverview();
                await loadRecentEvents();
                if (API.isAdmin()) {
                    await loadAdminStats();
                }
                API.showToast('Dashboard refreshed', 'success');
            } catch (error) {
                API.showToast('Failed to refresh', 'error');
            } finally {
                API.hideLoader();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
